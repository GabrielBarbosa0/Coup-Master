<!doctype html>
<html lang="pt-BR">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Coup Master - Protótipo</title>
  <link rel="shortcut icon" href="img/coup.png" type="image/x-icon">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400..900&display=swap" rel="stylesheet">

  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=info" />


  <style>
    :root {
      --bg: #171d26;
      --panel: #232a33;
      --accent: #1e90ff;
      --card-radius: 10px;
      --dotted: 3px dotted rgba(255, 255, 255, 0.12);
      --text: #e6eef6;
      --muted: rgba(230, 238, 246, 0.25);
    }


    * {
      font-family: "Cinzel", serif !important;

    }

    html,
    body {
      height: 100%;
      margin: 0;
      background: #14171e;
      color: var(--text);
    }


    .container {
      max-width: 1100px;
      margin: auto;
      padding: 12px;
    }

    header {
      border-radius: 18px;
      border: 3px dashed rgba(255, 255, 255, 0.12);
      padding: 26px 18px;
      text-align: center;
      background: #232a33;
      color: #ffffff;
      margin-bottom: 18px;

      /* [NOVO] Inicia OCULTO por padrão */
      display: none;
    }



    header h1 {
      margin: 0;
      font-size: 34px;
      letter-spacing: 1px;
    }

    header p {
      margin: 6px 0 0;
      color: #444;
    }

    .resetBtn,
    .infoBtn,
    .shuffleBtn,
    .configBtn,
    .musicBtn {
      /* Adicionado configBtn */
      width: 36px;
      height: 36px;
    }

    .shuffleBtn {
      display: none !important;
      /* Oculta o botão de embaralhar */
    }


    .infoBtn img,
    .configBtn img,
    .musicBtn img {
      width: 100%;
      height: 100%;
      display: block;
    }


    /* [NOVO] Estilo visual para quando a música estiver desligada */
    .musicBtn.muted {
      opacity: 0.4;
      /* Fica "apagado" */
      filter: grayscale(100%);
      /* Fica cinza */
    }


    /* [NOVO] Estilo do Slider de Volume */
    #volumeSlider {
      width: 60px;
      /* Largura compacta */
      height: 6px;
      background: #232a33;
      border-radius: 5px;
      outline: none;
      opacity: 0.7;
      transition: opacity .2s;
      cursor: pointer;
      align-self: center;
      /* Centraliza verticalmente na barra */
      accent-color: #1e90ff;
      /* Cor azul do tema para a "bolinha" do slider */
    }

    #volumeSlider:hover {
      opacity: 1;
    }


    /* Board */
    .board {
      background: var(--bg);
      border-radius: 14px;
      border: 3px dashed rgba(255, 255, 255, 0.12);
      padding: 18px;
      box-shadow: 0 8px 24px rgba(10, 10, 12, 0.08);
    }

    .top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .room {
      color: var(--muted);
      font-size: 14px;
    }

    .controls {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    /* [CORREÇÃO] Aplicando o estilo também ao .resetBtn */
    .controls button,
    .resetBtn {
      padding: 8px;
      /* Padronizado */
      border-radius: 8px;
      border: 0;
      background: var(--panel);
      color: white;
      cursor: pointer;
      /* Adicionado para centralizar os SVGs */
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Central area layout (NOVO) */
    .center-area {
      display: flex;
      flex-direction: column;
      gap: 18px;
      /* Espaço entre a linha dos players e a linha da mesa */
    }

    /* (NOVO) Container para os 3 jogadores no topo */
    .player-hands-container {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 18px;
    }

    /* [NOVO] Wrapper para Asilo e Deck */
    .decks-wrapper {
      display: grid;
      grid-template-columns: 1fr 1fr; /* Lado a lado */
      gap: 18px;
      margin-top: 18px;
    }

    /* Player areas labels (AJUSTADO) */
    .player-area {
      border-radius: 10px;
      border: 3px dashed #ffffff0f;
      padding: 8px;
      min-height: 140px;
      display: flex;
      /* Esta linha já existe */
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      position: relative;
    }

    /* Esconde todos os jogadores por padrão para evitar o "flash" */
    .player-hands-container>.player-area {
      display: none;
    }


    /* === [CORREÇÃO] ESTILO DO BOTÃO DE REMOVER === */
    .points {
      /* [CORREÇÃO] Layout centralizado */
      display: flex;
      align-items: center;
      /* gap: 4px; <-- REMOVIDO CONFORME SOLICITADO */
      margin-top: 4px;
      /* Espaçamento */
      margin-bottom: 8px;
      /* Espaçamento */
      justify-content: center;
    }

    .remove-player {
      /* [CORREÇÃO] Botão Kickar agora é separado */
      position: absolute;
      right: 8px;
      /* Alinhado à DIREITA */
      top: 8px;

      background: #ff3b3b;
      width: 12px;
      height: 12px;
      color: white;
      font-size: 0;
      line-height: 0;
      border-radius: 50%;
      border: 1px solid white;
      cursor: pointer;
      padding: 0;
    }

    .remove-player:hover {
      background: #ff5555;
    }

    /* === FIM NOVO ESTILO === */

    /* === [NOVO] ESTILO PARA RELIGIÃO === */
    .religion-status {
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      color: white;
      margin-bottom: 8px;
      /* Ajusta espaço */
      cursor: pointer;
      user-select: none;
      border: 1px solid #ffffff4d;
    }

    .religion-status.catolico {
      background-color: #3b5998;
      /* Azul */
    }

    .religion-status.protestante {
      background-color: #e6750b;
      /* Laranja */
    }

    /* === FIM NOVO ESTILO === */


    .player-title {
      font-weight: 600;
      margin-bottom: 0px;
      color: var(--muted);
      /* margin-top: 10px; [NOVO] Empurra o nome para baixo */
    }

    .player-area.local-player .player-title {
      color: var(--accent);
      font-weight: 700;
    }


    /* [NOVO] Estilo da Foto de Perfil na Mesa */
    .player-header {
      display: flex;
      align-items: center;
      gap: 8px;
      /* margin-bottom: 5px; */
      justify-content: center;
    }
    .player-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 2px solid var(--accent);
      object-fit: cover;
    }
    .player-title {
      margin: 0; /* Remove margem antiga */
    }

    /* Deck area (AJUSTADO) */
    .deck-area {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 18px;
      border-radius: 18px;
      border: 3px dashed #1e90ff;
      background: var(--panel);
      /* min-height: 200px; */
    }

    /* === [NOVO] ESTILO PARA ÁREA DO ASILO === */
    .asylum-area {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 18px;
      border-radius: 18px;
      border: 3px dashed #ff7b00;
      /* Borda laranja */
      background: var(--panel);
      /* min-height: 200px; */
      text-align: center;
    }

    .asylum-area .muted {
      font-size: 14px;
      font-weight: bold;
    }

    .asylum-image {
      width: 76px;
      height: 76px;
      background-image: url('img/asilo.png');
      /* Caminho da imagem */
      background-size: cover;
      background-position: center;
      border-radius: 10px;
    }

    .asylum-points {
      display: flex;
      /* gap: 6px; */
      align-items: center;
    }

    .asylum-points button {
      background: #f6c204;
      color: #000;
      border: 0;
      cursor: pointer;

      /* === [CORREÇÃO] Círculo Perfeito === */
      width: 22px;
      /* Mesmo tamanho dos botões de jogador */
      height: 22px;
      border-radius: 50%;
      /* Garante um círculo perfeito */

      /* Centralização do + e - */
      padding: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
      font-size: 16px;
    }

    .asylum-points .score {
      min-width: 28px;
      text-align: center;
      color: #fff;
    }

    /* === FIM NOVO ESTILO === */


    .deck {
      width: 72px;
      height: 107px;
      border-radius: 10px;
      cursor: pointer;

      /* [NOVO] Aplicando a imagem de verso no Deck */
      background-image: url('./img/back.png');
      background-size: cover;
      background-position: center;

      /* border: #1e90ff 3px solid; */

      /* Esconde o texto "Deck" que estava lá antes */
      text-indent: -9999px;
      overflow: hidden;
    }

    .pile-info {
      display: flex;
      gap: 12px;
      align-items: center;
      text-align: center;
    }

    /* Free area below (AJUSTADO) */
    .free-area {
      border-radius: 12px;
      border: 3px dashed #ffffff1f;
      padding: 18px;
      min-height: 140px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: flex-start;
      justify-content: flex-start;
      background: linear-gradient(180deg, #0000000d, #00000005);
      text-align: center;

      /* [NOVO] Necessário para posicionar a caveira no fundo */
      position: relative;
      z-index: 1;
      overflow: hidden; /* Garante que a imagem não saia das bordas arredondadas */
    }

    /* [NOVO] Caveira de fundo semitransparente */
    .free-area::before {
      content: "";
      background-image: url('img/skull.svg'); /* Caminho da sua imagem */
      background-repeat: no-repeat;
      background-position: center;
      background-size: 30%; /* Ajuste o tamanho da caveira aqui (ex: 100px ou 30%) */
      opacity: 0.03; /* Ajuste a transparência (0.1 é bem fraco, 1.0 é total) */
      
      /* Posicionamento absoluto para cobrir a área */
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1; /* Fica atrás das cartas e do texto */
      pointer-events: none; /* Garante que não atrapalhe os cliques */
    }


    /* Cards */
    .card {
      width: 92px;
      height: 128px;
      border-radius: 10px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.25);
      cursor: grab;
      user-select: none;
      /* [NOVO] Estilos para a imagem de fundo */
      background-size: cover;
      /* Ajusta a imagem para cobrir o elemento */
      background-position: center;
      /* Centraliza a imagem */
      background-repeat: no-repeat;
      /* Evita repetição */
      display: block;
      /* Garante que a div se comporta como um bloco para a imagem */
      text-indent: -9999px;
      /* Esconde o texto para leitores de tela */
      overflow: hidden;
      /* Garante que o texto escondido não afete o layout */
    }



    .card:active {
      cursor: grabbing;
    }

    .card.small {
      width: 74px;
      height: 108px
    }


    .card:active {
      cursor: grabbing;
    }


    .card.back {
      background-image: url('./img/back.png');
      color: transparent
    }

    .card .label {
      padding: 6px;
      text-align: center;
      color: #0b0b0b
    }

    /* Hand layout */
    .player-hand {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
      /* [CORREÇÃO] MUDADO de 'nowrap' para 'wrap' */
      padding: 6px;
    }


    /* [CORREÇÃO] Aplicando o Grid de 3 colunas no seletor correto */
    .player-stack {
      display: grid;
      grid-template-columns: repeat(3, auto);
      /* gap: 8px; */
      justify-content: center;
      align-items: center;
      padding: 6px;
      width: 100%;
    }

    /* Points controls */
    /* [CORRIGIDO] Estilo dos botões + e - */
    .points .plus,
    .points .minus {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      border: 0;
      background: #f6c204;
      color: #000;
      cursor: pointer;

      /* Centralização do + e - */
      padding: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
      font-size: 16px;
    }

    .points .score {
      min-width: 28px;
      text-align: center;
      color: #fff;
    }

    /* small labels */
    .muted {
      color: var(--muted);
      font-size: 12px
    }

    /* small helpers */
    .slot {
      width: 96px;
      height: 136px;
      border-radius: 12px;
      border: 2px dashed rgba(255, 255, 255, 0.06);
      display: flex;
      align-items: center;
      justify-content: center
    }

    .slot.small {
      width: 76px;
      height: 110px
    }

    /* Responsive adjustments */
    @media (max-width:1024px) {
      .container {
        padding: 8px
      }

      header h1 {
        font-size: 28px
      }

      .player-hands-container {
        grid-template-columns: repeat(2, 1fr);
        /* 2x2 grid para tablets */
      }

      /* [CORREÇÃO] Responsividade do grid inferior */
      .bottom-table-container {
        grid-template-columns: 1fr;
        /* Stacka área livre, asilo e deck */
      }

      .deck {
        width: 72px;
        height: 107px
      }

      .card {
        width: 72px;
        height: 100px
      }

      .slot {
        width: 76px;
        height: 110px
      }

      .player-hand {
        gap: 8px
      }

      .card.small {
        width: 72px;
        height: 107px
      }

      .free-area {
        min-height: 100px
      }
    }

    @media (max-width:520px) {
      .center-area {
        gap: 8px;
      }

      .player-hands-container {
        grid-template-columns: 1fr;
        /* Stacka os 4 players */
        gap: 8px;
      }

      .bottom-table-container {
        grid-template-columns: 1fr;
        /* Stacka área livre, asilo e deck */
        gap: 8px;
      }

      .card {
        width: 58px;
        height: 84px
      }

      .slot {
        width: 58px;
        height: 84px
      }

      .player-area {
        padding: 6px;
        min-height: 110px;
      }

      .points {
        right: 4px;
        top: 4px
      }

      .remove-player {
        right: 4px;
        /* Garante que ele fique à direita no mobile */
        top: 4px;
      }

      .bottom-table-container {
        grid-template-columns: 1fr; /* Empilha: Cemitério em cima, Wrapper embaixo */
        gap: 8px;
      }

      /* [NOVO] No mobile, mantém Asilo e Deck lado a lado! */
      .decks-wrapper {
        grid-template-columns: 1fr 1fr; 
        gap: 8px;
        margin-top: 8px;
      }
      
      /* Opcional: Ajuste fino para caber melhor em telas pequenas */
      .asylum-area, .deck-area {
          padding: 10px; /* Menos padding no mobile */
      }

      .free-area {
      justify-content: center;
    }

    }

    /* === ESTILOS DO MODAL E FLIP-CARD === */
    .modal-overlay {
      display: none;
      /* Escondido por padrão */
      position: fixed;
      /* Cobre a tela inteira */
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      /* Fundo escuro */

      /* Para centralizar o conteúdo */
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      position: relative;
      padding: 20px;
      background: var(--panel);
      border-radius: 10px;
    }

    .modal-actions-and-rules {
      position: relative;
      padding: 20px;
      border-radius: 10px;
    }

    /* [NOVO] Estilos para o Modal de Configurações */
    .settings-container {
        display: flex;
        flex-direction: column;
        gap: 15px;
        min-width: 250px;
        padding: 10px;
    }

    .setting-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        color: var(--text);
        font-size: 16px;
    }

    /* Estilo para botões com ícone dentro do menu */
    .icon-btn {
        background: #232a33;
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 8px;
        padding: 8px 12px;
        color: var(--text);
        cursor: pointer;
        display: flex;
        align-items: center;
        transition: background 0.2s;
    }
    .icon-btn:hover {
        background: #2c3540;
    }
    
    /* Ajuste do Slider dentro do modal */
    #volumeSlider {
        accent-color: #1e90ff;
        flex-grow: 1;
        cursor: pointer;
    }

    .close-btn {
      position: absolute;
      top: -10px;
      right: -10px;
      z-index: 1001;
      color: #fff;
      background: #ff3b3b;
      border: 2px solid white;
      border-radius: 50%;
      width: 35px;
      height: 35px;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      line-height: 30px;
      /* Alinha o 'X' verticalmente */
      text-align: center;
      /* Alinha o 'X' horizontalmente */
    }

    .close-btn:hover {
      background: #ff5555;
    }

    /* --- Estilos do Flip-Card --- */
    
    /* [NOVO] A carta só gira se tiver a classe 'is-flipped' */
    .flip-card.is-flipped .flip-card-inner {
      transform: rotateY(-180deg);
    }

    .flip-horizontal-left .flip-card-back {
      transform: rotateY(-180deg);
    }

    .flip-card {
      background-color: transparent;
      width: 300px;
      height: 450px;
      perspective: 1000px;
    }

    .flip-card-inner {
      position: relative;
      width: 100%;
      height: 100%;
      transition: transform 1s;
      transform-style: preserve-3d;
    }

    .flip-card-front,
    .flip-card-back {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
    }

    .flip-card-front img,
    .flip-card-back img {
      width: 100%;
      height: auto; /* A altura se ajusta sozinha */
      border-radius: 25px;
      object-fit: cover;
    }

    /* === [NOVO] ESTILOS DO MODAL DE CONFIGURAÇÃO === */
    .card-config-list {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 60vh;
      overflow-y: auto;
    }

    .card-config-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      border-bottom: 1px solid var(--bg);
    }

    .card-config-item label {
      font-size: 18px;
      color: var(--text);
    }

    .card-config-item input {
      width: 60px;
      padding: 5px;
      border-radius: 5px;
      border: 1px solid var(--accent);
      background: var(--bg);
      color: var(--text);
      font-size: 16px;
      text-align: center;
    }

    .card-config-item input:disabled {
      background: #555;
      color: #999;
      border-color: #555;
    }

    /* Estilo para o novo botão Aplicar */
    #applyDeckConfigBtn {
      width: 100%;
      padding: 12px;
      font-size: 18px;
      background: #00ff73;
      /* Verde neon */
      color: #111;
      border: 0;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 15px;
    }

    #applyDeckConfigBtn:disabled {
      background: #555;
      color: #999;
    }

    /* === FIM DOS NOVOS ESTILOS === */
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>Coup Master</h1>
    </header>

    <div class="board">
      <div class="top-row">
        <div class="room muted">
          <button id="resetBtn" class="resetBtn" title="Resetar Mesa"><img src="img/cached.svg" alt=""></button>
        </div>
        <div class="controls">
          <button id="musicBtn" class="musicBtn" title="Música de Fundo"><img src="img/music_note.svg" alt="Música"></button>
          <button id="infoBtn" class="infoBtn" title="Ver Ações"><img src="img/info.svg" alt="Ajuda"></button>
          <button id="settingsBtn" class="configBtn" title="Configurações Gerais"><img src="img/settings.svg" alt="Configurações"></button>
        </div>
      </div>

      <div class="center-area" id="centerArea">

        <div class="player-hands-container">

          <div class="player-area" id="player-1" data-player="1">
            <button class="remove-player" data-pid="1" title="Remover Jogador"></button>
            <div class="player-title">Jogador 1</div>
            <div class="points">
              <button class="minus">-</button>
              <div class="score" data-score="0">0</div>
              <button class="plus">+</button>
            </div>
            <div class="religion-status" data-pid="1">Católico</div>
            <div class="player-stack hand" data-hand></div>
          </div>

          <div class="player-area" id="player-2" data-player="2">
            <button class="remove-player" data-pid="2" title="Remover Jogador"></button>
            <div class="player-title">Jogador 2</div>
            <div class="points">
              <button class="minus">-</button>
              <div class="score" data-score="0">0</div>
              <button class="plus">+</button>
            </div>
            <div class="religion-status" data-pid="2">Católico</div>
            <div class="player-stack hand" data-hand></div>
          </div>

          <div class="player-area" id="player-3" data-player="3">
            <button class="remove-player" data-pid="3" title="Remover Jogador"></button>
            <div class="player-title">Jogador 3</div>
            <div class="points">
              <button class="minus">-</button>
              <div class="score" data-score="0">0</div>
              <button class="plus">+</button>
            </div>
            <div class="religion-status" data-pid="3">Católico</div>
            <div class="player-stack hand" data-hand></div>
          </div>

          <div class="player-area" id="player-4" data-player="4">
            <button class="remove-player" data-pid="4" title="Remover Jogador"></button>
            <div class="player-title">Jogador 4</div>
            <div class="points">
              <button class="minus">-</button>
              <div class="score" data-score="0">0</div>
              <button class="plus">+</button>
            </div>
            <div class="religion-status" data-pid="4">Católico</div>
            <div class="player-stack hand" data-hand></div>
          </div>

          <div class="player-area" id="player-5" data-player="5">
            <button class="remove-player" data-pid="5" title="Remover Jogador"></button>
            <div class="player-title">Jogador 5</div>
            <div class="points">
              <button class="minus">-</button>
              <div class="score" data-score="0">0</div>
              <button class="plus">+</button>
            </div>
            <div class="religion-status" data-pid="5">Católico</div>
            <div class="player-stack hand" data-hand></div>
          </div>

          <div class="player-area" id="player-6" data-player="6">
            <button class="remove-player" data-pid="6" title="Remover Jogador"></button>
            <div class="player-title">Jogador 6</div>
            <div class="points">
              <button class="minus">-</button>
              <div class="score" data-score="0">0</div>
              <button class="plus">+</button>
            </div>
            <div class="religion-status" data-pid="6">Católico</div>
            <div class="player-stack hand" data-hand></div>
          </div>

          <div class="player-area" id="player-7" data-player="7">
            <button class="remove-player" data-pid="7" title="Remover Jogador"></button>
            <div class="player-title">Jogador 7</div>
            <div class="points">
              <button class="minus">-</button>
              <div class="score" data-score="0">0</div>
              <button class="plus">+</button>
            </div>
            <div class="religion-status" data-pid="7">Católico</div>
            <div class="player-stack hand" data-hand></div>
          </div>

          <div class="player-area" id="player-8" data-player="8">
            <button class="remove-player" data-pid="8" title="Remover Jogador"></button>
            <div class="player-title">Jogador 8</div>
            <div class="points">
              <button class="minus">-</button>
              <div class="score" data-score="0">0</div>
              <button class="plus">+</button>
            </div>
            <div class="religion-status" data-pid="8">Católico</div>
            <div class="player-stack hand" data-hand></div>
          </div>
        </div>
        <div class="bottom-table-container">

          <div class="free-area" id="freeArea" data-area="free">
            <div class="muted" style="width:100%;">Cemitério — arraste cartas aqui para torná-las visíveis a todos
            </div>
          </div>

          <div class="decks-wrapper">
            
            <div class="asylum-area" id="asylumArea">
              <div class="muted">Asilo</div>
              <div class="asylum-image">
                </div>
              <div class="asylum-points">
                <button id="asylum-minus" title="Remover Moeda do Asilo">-</button>
                <div id="asylum-score" class="score">0</div>
                <button id="asylum-plus" title="Adicionar Moeda ao Asilo">+</button>
              </div>
            </div>

            <div class="deck-area" id="deck-area">
              <div class="pile-info muted">
              </div>
              <div class="deck" id="deck" draggable="true">Deck</div>
              <div class="pile-info muted">
                <div>Cartas no deck: <span id="deck-count"></div>
              </div>
            </div>

          </div> 
          </div>
      </div>
    </div>
  </div>

  <div id="infoModal" class="modal-overlay" style="display: none;">
    <div class="modal-actions-and-rules">
      <button id="closeModalBtn" class="close-btn">&times;</button>

      <div class="flip-card flip-horizontal-left">
        <div class="flip-card-inner">
          <div class="flip-card-front">
            <img src="img/front-actions.jpg" alt="Ações Personagens - Frente">
          </div>
          <div class="flip-card-back">
            <img src="img/back-actions.jpg" alt="Ações Personagens - Verso">
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="configModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <button id="closeConfigModalBtn" class="close-btn">&times;</button>
      <h2>Configurar Baralho</h2>
      <p class="muted">(Use 0 para remover uma carta)</p>
      <ul class="card-config-list">
        <li class="card-config-item">
          <label for="config-duque">Duque</label>
          <input type="number" id="config-duque" data-card="duque" min="0" max="10" value="5">
        </li>
        <li class="card-config-item">
          <label for="config-capitao">Capitão</label>
          <input type="number" id="config-capitao" data-card="capitao" min="0" max="10" value="5">
        </li>
        <li class="card-config-item">
          <label for="config-assassino">Assassino</label>
          <input type="number" id="config-assassino" data-card="assassino" min="0" max="10" value="5">
        </li>
        <li class="card-config-item">
          <label for="config-embaixador">Embaixador</label>
          <input type="number" id="config-embaixador" data-card="embaixador" min="0" max="10" value="5">
        </li>
        <li class="card-config-item">
          <label for="config-condessa">Condessa</label>
          <input type="number" id="config-condessa" data-card="condessa" min="0" max="10" value="5">
        </li>
        <li class="card-config-item">
          <label for="config-inquisidor">Inquisidor</label>
          <input type="number" id="config-inquisidor" data-card="inquisidor" min="0" max="10" value="5">
        </li>
        <li class="card-config-item">
          <label for="config-benfeitor">Benfeitor</label>
          <input type="number" id="config-benfeitor" data-card="benfeitor" min="0" max="10" value="0">
        </li>
        <li class="card-config-item">
          <label for="config-bufao">Bufão</label>
          <input type="number" id="config-bufao" data-card="bufao" min="0" max="10" value="0">
        </li>
        <li class="card-config-item">
          <label for="config-burgues">Burguês</label>
          <input type="number" id="config-burgues" data-card="burgues" min="0" max="10" value="0">
        </li>
        <li class="card-config-item">
          <label for="config-burocrata">Burocrata</label>
          <input type="number" id="config-burocrata" data-card="burocrata" min="0" max="10" value="0">
        </li>
        <li class="card-config-item">
          <label for="config-vigilante">Vigilante</label>
          <input type="number" id="config-vigilante" data-card="vigilante" min="0" max="10" value="0">
        </li>
        <li class="card-config-item">
          <label for="config-mercenario">Mercenário</label>
          <input type="number" id="config-mercenario" data-card="mercenario" min="0" max="10" value="0">
        </li>
        <li class="card-config-item">
          <label for="config-guardiao_real">Guardião Real</label>
          <input type="number" id="config-guardiao-real" data-card="guardiao-real" min="0" max="10" value="0">
        </li>
        <li class="card-config-item">
          <label for="config-purificador">Purificador</label>
          <input type="number" id="config-purificador" data-card="purificador" min="0" max="10" value="0">
        </li>
        <li class="card-config-item">
          <label for="config-tesoureiro_da_coroa">Tesoureiro da Coroa</label>
          <input type="number" id="config-tesoureiro_da_coroa" data-card="tesoureiro_da_coroa" min="0" max="10"
            value="0">
        </li>
        <li class="card-config-item">
          <label for="config-diplomata">Diplomata</label>
          <input type="number" id="config-diplomata" data-card="diplomata" min="0" max="10" value="0">
        </li>
        <li class="card-config-item">
          <label for="config-marionetista">Marionetista</label>
          <input type="number" id="config-marionetista" data-card="marionetista" min="0" max="10" value="0">
        </li>
        <li class="card-config-item">
          <label for="config-contador_real">Contador Real</label>
          <input type="number" id="config-contador_real" data-card="contador_real" min="0" max="10" value="0">
        </li>
        <li class="card-config-item">
          <label for="config-contrabandista">Contrabandista</label>
          <input type="number" id="config-contrabandista" data-card="contrabandista" min="0" max="10" value="0">
        </li>
        <li class="card-config-item">
          <label for="config-camaleao">Camaleão</label>
          <input type="number" id="config-camaleao" data-card="camaleao" min="0" max="10" value="0">
        </li>
      </ul>
      <button id="applyDeckConfigBtn">Aplicar e Resetar Jogo</button>
    </div>
  </div>

  <div id="settingsModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <button id="closeSettingsBtn" class="close-btn">&times;</button>
      <h2>Configurações</h2>
      
      <div class="settings-container">
        
        <div class="setting-row">
            <label for="volumeSlider">Música:</label>
            <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="0.1" style="width: 100%;">
        </div>

        <div class="setting-row">
            <label>Interface:</label>
            <button id="toggleHeaderBtn" class="icon-btn" title="Mostrar/Ocultar Título">
                <img src="img/visibility.svg" alt="Ver" style="width: 24px; height: 24px;">
                <span style="margin-left: 8px;">Título do Jogo</span>
            </button>
        </div>

        <div class="setting-row" style="justify-content: center; margin-top: 20px;">
             <button id="openDeckConfigBtn" style="background: #1e90ff; color: white; padding: 10px; border: 0; border-radius: 8px; cursor: pointer; width: 100%;">
                Configurar Baralho
             </button>
        </div>

      </div>
    </div>
  </div>

  <audio id="bgmAudio" loop autoplay>
    <source src="audio/bgm.mp3" type="audio/mpeg">
  </audio>


  <audio id="audio-coin" src="audio/coin.mp3"></audio>
  <audio id="audio-paper" src="audio/paper.mp3"></audio>
  <audio id="audio-knife" src="audio/knife.mp3"></audio>
  <audio id="audio-impact" src="audio/impact.mp3"></audio>
  <audio id="audio-8-bit-start" src="audio/8-bit-start.mp3"></audio>
  <audio id="audio-card-slide" src="audio/card-slide.mp3"></audio>
  <audio id="audio-shuffle" src="audio/shuffle.mp3"></audio>
  <audio id="audio-click" src="audio/click.mp3"></audio>


  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <script>

    // =======================================================
    // === 1. INICIALIZAÇÃO E CONFIGURAÇÃO DO FIREBASE ===
    // =======================================================

    const firebaseConfig = {
      apiKey: "AIzaSyDQwhYeLEvJW4p9Ml4pKjmr520CeKnZa60",
      authDomain: "coup-master.firebaseapp.com",
      databaseURL: "https://coup-master-default-rtdb.firebaseio.com",
      projectId: "coup-master",
      storageBucket: "coup-master.firebasestorage.app",
      messagingSenderId: "876117110623",
      appId: "1:876117110623:web:b957a148f9f60a51b550ea",
      measurementId: "G-2BQR65QP2Z"
    };

    // Inicializa o Firebase
    if (!firebaseConfig.apiKey) {
      document.body.innerHTML = "<h1>Erro: configure o firebaseConfig no script!</h1>";
      console.error("Firebase config is missing!");
    }

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // =======================================================
    // === 1.1 VERIFICAÇÃO DE LOGIN E SALA (NOVO) ===
    // =======================================================
    
    // 1. Pega o código da sala da URL (?room=XXXX)
    const urlParams = new URLSearchParams(window.location.search);
    const roomCode = urlParams.get('room');

    // 2. Pega os dados do usuário logado (vindos do Lobby)
    const currentUser = {
        uid: sessionStorage.getItem('currentUID'),
        name: sessionStorage.getItem('currentName'),
        photo: sessionStorage.getItem('currentPhoto')
    };

    // 3. Segurança: Se não tem sala ou não tem user logado, manda pro Lobby
    if (!roomCode || !currentUser.uid) {
        window.location.href = 'lobby.html';
    }

    // [IMPORTANTE] Agora a referência muda para a sala específica!
    const gameStateRef = db.ref(`salas/${roomCode}/gameState`);


    // =======================================================
    // === 2. VARIÁVEIS GLOBAIS E UTILITÁRIOS ===
    // =======================================================

    // [NOVO] FUNÇÃO DE TOCAR SOM
    function playSound(id) {
      const sound = document.getElementById('audio-' + id);
      if (sound) {
        sound.currentTime = 0; 
        sound.play().catch(e => console.log("Erro ao tocar som:", e));
      }
    }

    let lastSoundTimestamp = 0;

    // Função que manda o som para TODOS os jogadores
    function triggerSound(soundId) {
      db.ref(`salas/${roomCode}/gameState/lastSFX`).set({
        id: soundId,
        timestamp: Date.now()
      });
    }

    const CARD_TYPES = [
      { type: 'duque', color: '#f6b04d' },
      { type: 'capitao', color: '#ff3b3b' },
      { type: 'assassino', color: '#3aff7b' },
      { type: 'embaixador', color: '#49f0ff' },
      { type: 'condessa', color: '#ffb000' },
      { type: 'inquisidor', color: '#2a8cff' },
      { type: 'benfeitor', color: '#C0C0C0' },
      { type: 'bufao', color: '#FF69B4' },
      { type: 'burgues', color: '#800080' },
      { type: 'burocrata', color: '#A52A2A' },
      { type: 'vigilante', color: '#FFFFFF' },
      { type: 'mercenario', color: '#FFFFFF' },
      { type: 'guardiao-real', color: '#FFFFFF' },
      { type: 'purificador', color: '#FFFFFF' },
      { type: 'tesoureiro_da_coroa', color: '#FFFFFF' },
      { type: 'diplomata', color: '#FFFFFF' },
      { type: 'marionetista', color: '#FFFFFF' },
      { type: 'contador_real', color: '#FFFFFF' },
      { type: 'contrabandista', color: '#FFFFFF' },
      { type: 'camaleao', color: '#FFFFFF' }
    ];

    let localGameState = {};
    let myPlayerId = null; // Será definido pelo UID
    let isDrawingCard = false;

    // Referências do DOM
    const deckCountEl = document.getElementById('deck-count');
    const graveCountEl = document.getElementById('grave-count');
    const deckEl = document.getElementById('deck');
    const freeArea = document.getElementById('freeArea');
    const shuffleBtn = document.getElementById('shuffleBtn');
    const resetBtn = document.getElementById('resetBtn');
    const asylumScoreEl = document.getElementById('asylum-score');
    const asylumPlusBtn = document.getElementById('asylum-plus');
    const asylumMinusBtn = document.getElementById('asylum-minus');

    // =======================================================
    // === 3. FUNÇÕES LÓGICAS (DECK, CARTAS) ===
    // =======================================================

    function createDeck(config) {
      let newDeck = [];
      let id = 1;

      if (!config) {
        config = createDefaultDeckConfig();
      }

      for (const cardType in config) {
        const quantity = config[cardType];
        const cardInfo = CARD_TYPES.find(c => c.type === cardType);

        if (cardInfo && quantity > 0) {
          for (let i = 0; i < quantity; i++) {
            newDeck.push({
              id: 'c' + (id++),
              type: cardInfo.type,
              color: cardInfo.color,
              owner: null,
              visible: false,
              location: 'deck'
            });
          }
        }
      }
      shuffle(newDeck);
      return newDeck;
    }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    function findCardById(state, id) {
      if (!state || !id) return null;
      let card = state.deck?.find(c => c.id === id);
      if (card) return card;
      card = state.freeCards?.find(c => c.id === id);
      if (card) return card;
      card = state.grave?.find(c => c.id === id);
      if (card) return card;

      for (let p = 1; p <= 8; p++) {
        card = state.players?.[p]?.hand?.find(c => c.id === id);
        if (card) return card;
      }
      return null;
    }

    function removeCardFromLocation(state, cardId) {
      if (!state || !cardId) return;
      if (state.deck) state.deck = state.deck.filter(c => c.id !== cardId);
      if (state.freeCards) state.freeCards = state.freeCards.filter(c => c.id !== cardId);
      if (state.grave) state.grave = state.grave.filter(c => c.id !== cardId);

      if (state.players) {
        for (let p = 1; p <= 8; p++) {
          if (state.players[p]?.hand) {
            state.players[p].hand = state.players[p].hand.filter(c => c.id !== cardId);
          }
        }
      }
    }

    // =======================================================
    // === 4. RENDERIZAÇÃO (ATUALIZADA COM NOME E FOTO) ===
    // =======================================================

    function clearDOM() {
      document.querySelectorAll('[data-hand]').forEach(h => h.innerHTML = '');
      freeArea.querySelectorAll('.card').forEach(n => n.remove());
      document.querySelectorAll('.slot').forEach(n => n.remove());
      document.querySelectorAll('.player-area.local-player')
        .forEach(el => el.classList.remove('local-player'));
    }

    function createCardElement(card) {
      const el = document.createElement('div');
      el.className = 'card';
      el.draggable = true;
      el.dataset.cardId = card.id;

      if (shouldShowBack(card)) {
        el.classList.add('back');
      } else {
        const imageUrl = `./img/${card.type.toLowerCase()}.png`;
        el.style.backgroundImage = `url('${imageUrl}')`;
      }

      el.addEventListener('dragstart', (ev) => {
        ev.dataTransfer.setData('text/plain', card.id);
      });

      el.addEventListener('dblclick', () => {
        returnCardToDeck(card.id);
      });

      return el;
    }

    function shouldShowBack(card) {
      if (card.location === 'deck') return true;
      if (card.location === 'free') return false;
      if (card.location?.startsWith('player-')) {
        return card.owner !== myPlayerId;
      }
      return false;
    }

    function renderAll() {
      const state = localGameState;
      if (!state || !state.players) return;

      clearDOM();

      for (let pid = 1; pid <= 8; pid++) {

        const playerEl = document.getElementById(`player-${pid}`);
        if (!playerEl) continue;

        const player = state.players[pid] || { online: false, hand: [], score: 0, religion: 'catolico', uid: null };

        // [MODIFICADO] Mostra se estiver online OU se tiver DONO (reservado)
        if (player.online || player.uid) {
          playerEl.style.display = 'flex';
        } else {
          playerEl.style.display = 'none';
          continue;
        }

        const handContainer = document.querySelector(`#player-${pid} [data-hand]`);

        if (pid === myPlayerId) {
          playerEl.classList.add('local-player');
        }

        // [NOVO] RENDERIZA NOME E FOTO
        // Procura o container de cabeçalho ou cria se não existir
        let headerEl = playerEl.querySelector('.player-header');
        if (!headerEl) {
            const titleDiv = playerEl.querySelector('.player-title');
            headerEl = document.createElement('div');
            headerEl.className = 'player-header';
            
            const img = document.createElement('img');
            img.className = 'player-avatar';
            
            playerEl.insertBefore(headerEl, titleDiv);
            headerEl.appendChild(img);
            headerEl.appendChild(titleDiv);
        }

        // Atualiza dados de Nome e Foto
        const avatarImg = headerEl.querySelector('.player-avatar');
        const nameTxt = headerEl.querySelector('.player-title');
        
        avatarImg.src = player.photo || 'img/coup.png'; 
        nameTxt.textContent = player.name || `Jogador ${pid}`;
        
        // Se estiver offline mas reservado, deixa transparente
        playerEl.style.opacity = player.online ? '1' : '0.5';


        // Renderiza Religião
        const religionEl = playerEl.querySelector('.religion-status');
        if (religionEl) {
          if (player.religion === 'protestante') {
            religionEl.textContent = 'Protestante';
            religionEl.classList.remove('catolico');
            religionEl.classList.add('protestante');
          } else {
            religionEl.textContent = 'Católico';
            religionEl.classList.remove('protestante');
            religionEl.classList.add('catolico');
          }
        }

        // Renderiza Cartas
        player.hand?.forEach((card) => {
          const slot = document.createElement('div');
          slot.className = 'slot small';
          const el = createCardElement(card);
          el.classList.add('small');
          slot.appendChild(el);
          handContainer.appendChild(slot);
        });

        if (!player.hand || player.hand.length === 0) {
          const slot = document.createElement('div');
          slot.className = 'slot small';
          handContainer.appendChild(slot);
        }

        // Score
        const scoreEl = document.querySelector(`#player-${pid} .score`);
        scoreEl.textContent = player.score || 0;
      }

      // Renderiza Cemitério
      state.freeCards?.forEach(card => {
        const el = createCardElement(card);
        el.classList.add('small');
        freeArea.appendChild(el);
      });

      // Contadores
      deckCountEl.textContent = state.deck?.length || 0;
      if (asylumScoreEl) asylumScoreEl.textContent = state.asylumScore || 0;

      // Config Deck
      if (state.deckConfig) {
        for (const cardType in state.deckConfig) {
          const input = document.getElementById(`config-${cardType}`);
          if (input) input.value = state.deckConfig[cardType];
        }
      }
    }

    // =======================================================
    // === 5. AÇÕES DO JOGADOR ===
    // =======================================================

    function drawCard(targetPid = null) {
      const playerToReceive = targetPid || myPlayerId;
      if (!playerToReceive) return;

      if (isDrawingCard) return;
      isDrawingCard = true;
      triggerSound('card-slide');

      gameStateRef.transaction((currentState) => {
        if (!currentState || !currentState.deck || currentState.deck.length === 0) {
          isDrawingCard = false; 
          return;
        }

        const card = currentState.deck.pop();
        card.owner = playerToReceive;
        card.location = 'player-' + playerToReceive;
        card.visible = false;

        if (!currentState.players[playerToReceive].hand) {
          currentState.players[playerToReceive].hand = [];
        }
        currentState.players[playerToReceive].hand.push(card);

        return currentState;
      },
        (error, committed) => {
          isDrawingCard = false;
        });
    }

    function returnCardToDeck(cardId) {
      triggerSound('shuffle');
      gameStateRef.transaction((currentState) => {
        if (!currentState) return currentState;
        const card = findCardById(currentState, cardId);
        if (!card) return currentState;

        removeCardFromLocation(currentState, cardId);
        card.owner = null;
        card.location = 'deck';
        card.visible = false;
        if (!currentState.deck) currentState.deck = [];
        currentState.deck.push(card);
        shuffle(currentState.deck);
        return currentState;
      });
    }

    function moveCard(cardId, targetLocation, targetPlayerId = null) {
      if (targetLocation === 'player') triggerSound('card-slide');
      if (targetLocation === 'free') triggerSound('knife');
      if (targetLocation === 'deck') triggerSound('shuffle');

      gameStateRef.transaction((currentState) => {
        if (!currentState) return currentState;
        const card = findCardById(currentState, cardId);
        if (!card) return currentState;

        if (targetLocation === 'player') {
          removeCardFromLocation(currentState, cardId);
          card.owner = targetPlayerId;
          card.location = 'player-' + targetPlayerId;
          card.visible = false;
          if (!currentState.players[targetPlayerId].hand) currentState.players[targetPlayerId].hand = [];
          currentState.players[targetPlayerId].hand.push(card);
        }
        else if (targetLocation === 'free') {
          removeCardFromLocation(currentState, cardId);
          card.owner = null;
          card.location = 'free';
          card.visible = true;
          if (!currentState.freeCards) currentState.freeCards = [];
          currentState.freeCards.push(card);
        }
        else if (targetLocation === 'deck') {
          removeCardFromLocation(currentState, cardId);
          card.owner = null;
          card.location = 'deck';
          card.visible = false;
          if (!currentState.deck) currentState.deck = [];
          currentState.deck.push(card);
          shuffle(currentState.deck);
        }
        return currentState;
      });
    }

    // [ATUALIZADO] Kick Player agora limpa o UID também
    function kickPlayer(pid) {
      if (!confirm(`Tem certeza que deseja remover o Jogador ${pid}?`)) return;

      triggerSound('impact');

      // Se eu me kickar (sair da mesa)
      if (pid === myPlayerId) {
        window.location.href = 'lobby.html';
      }

      // Limpa TUDO do slot no Firebase (Libera a vaga para outro UID)
      db.ref(`salas/${roomCode}/gameState/players/${pid}`).update({
        online: false,
        uid: null,   // [IMPORTANTE] Libera a vaga
        name: null,
        photo: null,
        hand: [],
        score: 2
      });
    }

    function updateScore(pid, amount) {
      triggerSound('coin');
      const scoreRef = db.ref(`salas/${roomCode}/gameState/players/${pid}/score`);
      scoreRef.once('value', (snapshot) => {
        let newScore = (snapshot.val() || 0) + amount;
        if (newScore < 0) newScore = 0;
        scoreRef.set(newScore);
      });
    }

    function updateAsylumScore(amount) {
      triggerSound('coin');
      const scoreRef = db.ref(`salas/${roomCode}/gameState/asylumScore`);
      scoreRef.once('value', (snapshot) => {
        let newScore = (snapshot.val() || 0) + amount;
        if (newScore < 0) newScore = 0;
        scoreRef.set(newScore);
      });
    }

    function toggleReligion(pid) {
      triggerSound('paper');
      const religionRef = db.ref(`salas/${roomCode}/gameState/players/${pid}/religion`);
      religionRef.transaction((currentReligion) => {
        return (currentReligion === 'catolico') ? 'protestante' : 'catolico';
      });
    }

    function resetTable(newConfig = null) {
      console.log("Resetando a mesa...");
      triggerSound('8-bit-start');

      const configToUse = newConfig || localGameState.deckConfig || createDefaultDeckConfig();
      let newDeck = createDeck(configToUse);
      let currentPlayers = localGameState.players || {};

      let newPlayersState = {};
      
      // Mantém os jogadores e seus UIDs/Nomes, só reseta o jogo
      for(let i=1; i<=8; i++) {
          newPlayersState[i] = {
              online: currentPlayers[i]?.online || false,
              uid: currentPlayers[i]?.uid || null,
              name: currentPlayers[i]?.name || null,
              photo: currentPlayers[i]?.photo || null,
              hand: [],
              score: 2,
              religion: (i % 2 === 1) ? 'catolico' : 'protestante'
          };
      }

      let initialState = {
        deck: newDeck,
        grave: [],
        freeCards: [],
        asylumScore: 0,
        deckConfig: configToUse,
        players: newPlayersState
      };

      gameStateRef.set(initialState);
    }

    function shuffleDeck() {
      gameStateRef.transaction((currentState) => {
        if (currentState && currentState.deck) shuffle(currentState.deck);
        return currentState;
      });
    }

    function createDefaultDeckConfig() {
      return {
        'duque': 5, 'capitao': 5, 'assassino': 5, 'embaixador': 5, 'condessa': 5,
        'inquisidor': 5, 'benfeitor': 0, 'bufao': 0, 'burgues': 0, 'burocrata': 0,
        'vigilante': 0, 'guardiao_real': 0, 'mercenario': 0, 'purificador': 0, 'tesoureiro_da_coroa': 0,
        'diplomata': 0, 'marionetista': 0, 'contador_real': 0, 'contrabandista': 0, 'camaleao': 0
      };
    }

    // =======================================================
    // === 6. SETUP DE EVENTOS (DRAG DROP & UI) ===
    // =======================================================

    function setupDropzones() {
      deckEl.addEventListener('dragstart', (e) => {
          e.dataTransfer.setData('text/plain', 'DECK_DRAW_ACTION');
      });

      deckEl.ondragover = ev => ev.preventDefault();
      deckEl.ondrop = ev => {
        ev.preventDefault();
        const id = ev.dataTransfer.getData('text/plain');
        if (id !== 'DECK_DRAW_ACTION') moveCard(id, 'deck');
      };
      deckEl.onclick = () => drawCard();

      document.querySelectorAll('.player-area').forEach(area => {
        area.ondragover = ev => ev.preventDefault();
        area.ondrop = ev => {
          ev.preventDefault();
          const data = ev.dataTransfer.getData('text/plain');
          const pid = parseInt(area.dataset.player);

          if (data === 'DECK_DRAW_ACTION') {
              drawCard(pid);
          } else {
              moveCard(data, 'player', pid);
          }
        };
      });

      freeArea.ondragover = ev => ev.preventDefault();
      freeArea.ondrop = ev => {
        ev.preventDefault();
        const id = ev.dataTransfer.getData('text/plain');
        if (id !== 'DECK_DRAW_ACTION') moveCard(id, 'free');
      };
    }

    function setupUI() {
      // (O código da setupUI permanece IDÊNTICO ao anterior)
      // Vou resumir para não estourar o limite, mas a lógica é a mesma
      // de botões, modais, configurações, etc.
      
      const resetBtn = document.getElementById('resetBtn');
      if(resetBtn) resetBtn.onclick = () => { if (confirm("Resetar mesa?")) resetTable(); };

      const musicBtn = document.getElementById('musicBtn');
      const bgmAudio = document.getElementById('bgmAudio');
      if (bgmAudio) bgmAudio.volume = 0.1;

      if (musicBtn && bgmAudio) {
        bgmAudio.play().then(() => musicBtn.classList.remove('muted')).catch(() => musicBtn.classList.add('muted'));
        musicBtn.onclick = () => {
          if (bgmAudio.paused) { bgmAudio.play().then(() => musicBtn.classList.remove('muted')); }
          else { bgmAudio.pause(); musicBtn.classList.add('muted'); }
        };
      }

      const settingsBtn = document.getElementById('settingsBtn');
      const settingsModal = document.getElementById('settingsModal');
      const closeSettingsBtn = document.getElementById('closeSettingsBtn');
      const volumeSlider = document.getElementById('volumeSlider');
      const toggleHeaderBtn = document.getElementById('toggleHeaderBtn');
      const openDeckConfigBtn = document.getElementById('openDeckConfigBtn');

      if (settingsBtn && settingsModal) {
          settingsBtn.onclick = () => { playSound('click'); settingsModal.style.display = 'flex'; };
          if(closeSettingsBtn) closeSettingsBtn.onclick = () => { playSound('click'); settingsModal.style.display = 'none'; };
      }
      if (volumeSlider && bgmAudio) {
          volumeSlider.value = bgmAudio.volume;
          volumeSlider.addEventListener('input', (e) => { bgmAudio.volume = e.target.value; });
      }
      if (toggleHeaderBtn) {
          const header = document.querySelector('header');
          toggleHeaderBtn.querySelector('img').src = 'img/visibility_off.svg';
          toggleHeaderBtn.style.opacity = '0.6';
          toggleHeaderBtn.onclick = () => {
              playSound('click');
              if (header.style.display === 'none') {
                  header.style.display = 'block';
                  toggleHeaderBtn.querySelector('img').src = 'img/visibility.svg';
                  toggleHeaderBtn.style.opacity = '1';
              } else {
                  header.style.display = 'none';
                  toggleHeaderBtn.querySelector('img').src = 'img/visibility_off.svg';
                  toggleHeaderBtn.style.opacity = '0.6';
              }
          };
      }

      const configModal = document.getElementById('configModal');
      const closeConfigModalBtn = document.getElementById('closeConfigModalBtn');
      if (openDeckConfigBtn && configModal) {
          openDeckConfigBtn.onclick = () => { playSound('click'); settingsModal.style.display = 'none'; configModal.style.display = 'flex'; };
          if(closeConfigModalBtn) closeConfigModalBtn.onclick = () => { playSound('click'); configModal.style.display = 'none'; settingsModal.style.display = 'flex'; };
      }

      const applyDeckConfigBtn = document.getElementById('applyDeckConfigBtn');
      const configInputs = document.querySelectorAll('.card-config-item input');
      configInputs.forEach(input => { if (myPlayerId !== 1) input.disabled = true; });
      if (applyDeckConfigBtn) {
          if (myPlayerId !== 1) {
              applyDeckConfigBtn.disabled = true; applyDeckConfigBtn.style.background = '#555'; applyDeckConfigBtn.textContent = 'Apenas o Host pode aplicar';
          } else {
              applyDeckConfigBtn.onclick = () => {
                  playSound('click');
                  const newConfig = {};
                  configInputs.forEach(input => {
                      let val = parseInt(input.value);
                      if (isNaN(val) || val < 0) val = 0; if (val > 10) val = 10;
                      newConfig[input.dataset.card] = val;
                  });
                  resetTable(newConfig);
                  configModal.style.display = 'none';
              };
          }
      }

      const infoBtn = document.getElementById('infoBtn');
      const infoModal = document.getElementById('infoModal');
      const closeInfoBtn = document.getElementById('closeModalBtn');
      const flipCard = document.querySelector('.flip-card');
      const frontImg = flipCard ? flipCard.querySelector('.flip-card-front img') : null;
      const backImg = flipCard ? flipCard.querySelector('.flip-card-back img') : null;
      const ruleImages = ['img/front-actions.png', 'img/dlc-actions.png', 'img/back-actions.png'];
      let currentRuleIndex = 0;
      if (infoBtn && infoModal) {
        infoBtn.onclick = () => { playSound('click'); infoModal.style.display = 'flex'; if (flipCard) { currentRuleIndex = 0; flipCard.classList.remove('is-flipped'); frontImg.src = ruleImages[0]; backImg.src = ruleImages[1]; } };
        if(closeInfoBtn) closeInfoBtn.onclick = () => { playSound('click'); infoModal.style.display = 'none'; };
        if (flipCard) {
          flipCard.onclick = () => {
            playSound('card-slide'); flipCard.classList.toggle('is-flipped'); currentRuleIndex = (currentRuleIndex + 1) % ruleImages.length;
            setTimeout(() => { const nextIndex = (currentRuleIndex + 1) % ruleImages.length; if (flipCard.classList.contains('is-flipped')) { frontImg.src = ruleImages[nextIndex]; } else { backImg.src = ruleImages[nextIndex]; } }, 500);
          };
        }
      }

      document.querySelectorAll('.player-area').forEach(area => {
        const pid = parseInt(area.dataset.player);
        const removeBtn = area.querySelector('.remove-player');
        if (removeBtn) removeBtn.addEventListener('click', () => kickPlayer(pid));
        const religionEl = area.querySelector('.religion-status');
        if (religionEl) religionEl.addEventListener('click', () => toggleReligion(pid));
        area.querySelector('.plus').addEventListener('click', () => updateScore(pid, 1));
        area.querySelector('.minus').addEventListener('click', () => updateScore(pid, -1));
      });

      if (document.getElementById('asylum-plus')) {
          document.getElementById('asylum-plus').onclick = () => updateAsylumScore(1);
          document.getElementById('asylum-minus').onclick = () => updateAsylumScore(-1);
      }
    }

    function setupAutoScroll() {
      const threshold = 80; const speed = 15;
      window.addEventListener('dragover', (e) => {
        const y = e.clientY; const viewportHeight = window.innerHeight;
        if (y < threshold) window.scrollBy(0, -speed);
        else if (y > (viewportHeight - threshold)) window.scrollBy(0, speed);
      });
    }

    // =======================================================
    // === 7. LÓGICA DE CONEXÃO INTELIGENTE (UID) ===
    // =======================================================

    function joinGame() {
      gameStateRef.transaction((currentState) => {
        // 1. Se a sala não existe, cria o estado inicial
        if (!currentState || !currentState.players) {
          const defaultConfig = createDefaultDeckConfig();
          let newDeck = createDeck(defaultConfig);

          let initialState = {
            deck: newDeck,
            grave: [],
            freeCards: [],
            asylumScore: 0,
            deckConfig: defaultConfig,
            players: {}
          };

          // Inicializa os 8 slots vazios
          for(let i=1; i<=8; i++) {
              initialState.players[i] = {
                  online: false, 
                  hand: [], 
                  score: 2, 
                  religion: (i % 2 === 1) ? 'catolico' : 'protestante',
                  uid: null,  // [IMPORTANTE] Sem dono
                  name: null,
                  photo: null
              };
          }
          
          // Ocupa o slot 1 para mim
          initialState.players[1].uid = currentUser.uid;
          initialState.players[1].name = currentUser.name;
          initialState.players[1].photo = currentUser.photo;
          initialState.players[1].online = true;
          
          myPlayerId = 1;
          return initialState;
        }

        // 2. Se a sala existe, procura meu lugar
        
        // A. Tenta RECONECTAR (Procura meu UID)
        for (let i = 1; i <= 8; i++) {
            if (currentState.players[i] && currentState.players[i].uid === currentUser.uid) {
                currentState.players[i].online = true; // Estou de volta!
                currentState.players[i].name = currentUser.name; 
                currentState.players[i].photo = currentUser.photo; 
                myPlayerId = i;
                return currentState;
            }
        }

        // B. Se não achou, procura slot VAZIO (Sem UID)
        for (let i = 1; i <= 8; i++) {
            if (!currentState.players[i].uid) { // Slot sem dono
                currentState.players[i].uid = currentUser.uid;
                currentState.players[i].name = currentUser.name;
                currentState.players[i].photo = currentUser.photo;
                currentState.players[i].online = true;
                
                // Reseta estado para novo jogador
                currentState.players[i].hand = [];
                currentState.players[i].score = 2;
                
                myPlayerId = i;
                return currentState;
            }
        }

        // C. Sala cheia
        return; 

      }, (error, committed) => {
        if (committed) {
            console.log(`Conectado com sucesso no Slot ${myPlayerId}`);
            setupDisconnectHandler(myPlayerId);
        } else {
            alert("Sala cheia! Todos os slots têm donos.");
            window.location.href = 'lobby.html';
        }
      });
    }

    function setupDisconnectHandler(pid) {
      // Quando desconectar, APENAS marca online: false.
      // O UID continua lá, garantindo a reserva.
      db.ref(`salas/${roomCode}/gameState/players/${pid}/online`).onDisconnect().set(false);
    }

    // =======================================================
    // === 8. INICIALIZAÇÃO ===
    // =======================================================

    function initializeGame() {
      // Listener do Estado do Jogo
      gameStateRef.on('value', (snapshot) => {
        const state = snapshot.val();
        if (state) {
          if (state.lastSFX && state.lastSFX.timestamp > lastSoundTimestamp) {
             lastSoundTimestamp = state.lastSFX.timestamp;
             playSound(state.lastSFX.id);
          }
          localGameState = state;
          renderAll();
        }
      });

      // Inicia conexão
      joinGame();

      // Configura UI
      setupUI();
      setupDropzones();
      setupAutoScroll();
    }

    initializeGame();

  </script>

</body>

</html>